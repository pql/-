# 1.ä»€ä¹ˆæ˜¯é¢å‘å¯¹è±¡
- æŠŠå®¢è§‚å¯¹è±¡æŠ½è±¡æˆå±æ€§å’Œå¯¹æ•°æ®çš„ç›¸å…³æ“ä½œï¼ŒæŠŠå†…éƒ¨ç»†èŠ‚å’Œä¸ç›¸å…³çš„ä¿¡æ¯éšè—èµ·æ¥ï¼ŒæŠŠåŒä¸€ä¸ªç±»å‹çš„å®¢è§‚å¯¹è±¡çš„å±æ€§æ•°æ®å’Œæ“ä½œç»‘å®šåœ¨ä¸€èµ·ï¼Œå°è£…æˆç±»ï¼Œå¹¶ä¸”å…è®¸åˆ†æˆä¸åŒå±‚æ¬¡è¿›è¡ŒæŠ½è±¡ï¼Œé€šè¿‡ç»§æ‰¿å®ç°å±æ€§å’Œæ“ä½œçš„å…±äº«
    - é¢å‘å¯¹è±¡çš„åˆ†æ OOA
    - é¢å‘å¯¹è±¡çš„è®¾è®¡ OOD
    - é¢å‘å¯¹è±¡çš„ç¼–ç¨‹ OOP
## 1.1 æ¦‚å¿µ
- ç±»ã€å¯¹è±¡ï¼ˆå®ä¾‹ï¼‰
- çˆ¶ç±»æ˜¯å…¬å…±çš„
```js
class Animal {
    constructor(name) {
        this.name = name;
    }
    eat() {
        console.log(`${this.name} eat`)
    }
}
let animal = new Person('åŠ¨ç‰©');
animal.eat();
```
## 1.2 ç»§æ‰¿
- å­ç±»ç»§æ‰¿çˆ¶ç±»
- ç»§æ‰¿å¯ä»¥æŠŠå…¬å…±æ–¹æ³•æŠ½ç¦»å‡ºæ¥ï¼Œæé«˜å¤ç”¨ï¼Œå‡å°‘å†—ä½™
```js
class Animal {
    constructor(name) {
        this.name = name;
    }
    eat() {
        console.log(`${this.name} eat`)
    }
    speak() {

    }
}
let animal = new Animal('åŠ¨ç‰©');
animal.eat();

class Dog extends Animal {
    constructor(name, age) {
        super(name);
        this.age = age;
    }
    bark() {
        console.log(`${this.name} is breaking!`);
    }
}
let dog=new Dog('ğŸ¶',5);
dog.eat();
dog.bark();
```
## 1.3 å°è£…
- æŠŠæ•°æ®å°è£…èµ·æ¥
- å‡å°‘è€¦åˆï¼Œä¸è¯¥å¤–éƒ¨è®¿é—®çš„ä¸è¦è®©å¤–éƒ¨è®¿é—®
- åˆ©äºæ•°æ®çš„æ¥å£æƒé™ç®¡ç†
- ES6 ç›®å‰ä¸æ”¯æŒï¼Œä¸€èˆ¬è®¤ä¸º_å¼€å¤´çš„éƒ½ä¼šç§æœ‰çš„ï¼Œä¸è¦ä½¿ç”¨
- å®ç°
    - public: å…¬æœ‰ä¿®é¥°ç¬¦ï¼Œå¯ä»¥åœ¨ç±»å†…æˆ–è€…ç±»å¤–ä½¿ç”¨publicä¿®é¥°çš„å±æ€§æˆ–è€…è¡Œä¸ºï¼Œé»˜è®¤ä¿®é¥°ç¬¦
    - protected: å—ä¿æŠ¤çš„ä¿®é¥°ç¬¦ï¼Œå¯ä»¥æœ¬ç±»å’Œå­ç±»ä¸­ä½¿ç”¨protectedä¿®é¥°çš„å±æ€§å’Œè¡Œä¸º
    - private: ç§æœ‰ä¿®é¥°ç¬¦ï¼Œåªå¯ä»¥åœ¨ç±»å†…ä½¿ç”¨privateä¿®é¥°çš„å±æ€§å’Œè¡Œä¸º
```js
class Animal {
    public name;
    protected age;
    private weight;
    constructor(name, age, weight) {
        this.name = name;
        this.age = age;
        this.weight = weight;
    }
}
class Person extends Animal {
    private money;
    constructor(name, age, weight, money) {
        super(name, age, weight);
        this.money = money;
    }
    getName() {
        console.log(this.name);
    }
    getAge() {
        console.log(this.age);
    }
    getWeight() {
        console.log(this.weight);
    }
}
let p = new Person('zfpx', 9, 100, 100);
console.log(p.name);
console.log(p.age);
console.log(p.weight);
```
```js
module: {
    rules: [
        {
            test: /\.js$/,
            use: {
                loader: 'babel-loader',
                options: {
                    presets: ["@babel/preset-env"]
                }
            }
        },
        {
            test: /\.ts$/,
            use: {
                loader: 'ts-loader'
            }
        }
    ]
}
```
## 1.4 å¤šæ€
- åŒä¸€ä¸ªæ¥å£å¯ä»¥ä¸åŒå®ç°
- ä¿æŒå­ç±»çš„å¼€æ”¾æ€§å’Œçµæ´»æ€§
- é¢å‘æ¥å£ç¼–ç¨‹
```js
class Animal {
    public name;
    protected age;
    private weight;
    constructor(name, age, weight) {
        this.name = name;
        this.age = age;
        this.weight = weight;
    }
}
class Person extends Animal {
    private money;
    constructor(name, age, weight, money) {
        super(name, age, weight);
        this.money = money;
    }
    speak() {
        console.log('ä½ å¥½!');
    }
}
class Dog extends Animal {
    private money;
    constructor(name, age, weight) {
        super(name, age, weight);
    }
    speak() {
        console.log('æ±ªæ±ªæ±ª!');
    }
}

let p = new Person('zfpx', 10, 10, 10);
p.speak();
let d = new Dog('zfpx', 10, 10);
d.speak();
```
# 2.è®¾è®¡åŸåˆ™
## 2.1 ä»€ä¹ˆæ˜¯è®¾è®¡ï¼Ÿ
- æŒ‰å“ªä¸€ç§æ€è·¯æˆ–è€…æ ‡å‡†æ¥å®ç°åŠŸèƒ½
- åŠŸèƒ½ç›¸åŒï¼Œå¯ä»¥æœ‰ä¸åŒè®¾è®¡çš„æ–¹å¼
- éœ€æ±‚å¦‚æœä¸æ–­å˜åŒ–ï¼Œè®¾è®¡çš„ä½œç”¨æ‰èƒ½ä½“ç°å‡ºæ¥
## 2.2 SOLIDäº”å¤§è®¾è®¡åŸåˆ™
| é¦–å­—æ¯ | æŒ‡ä»£ | æ¦‚å¿µ |
| --- | --- | --- |
| S | å•ä¸€èŒè´£åŸåˆ™ | å•ä¸€åŠŸèƒ½åŸåˆ™è®¤ä¸ºå¯¹è±¡åº”è¯¥ä»…å…·æœ‰ä¸€ç§å•ä¸€åŠŸèƒ½çš„æ¦‚å¿µ |
| O | å¼€æ”¾å°é—­åŸåˆ™ | å¼€é—­åŸåˆ™è®¤ä¸ºâ€œè½¯ä»¶ä½“åº”è¯¥æ˜¯å¯¹äºæ‰©å±•å¼€æ”¾çš„ï¼Œä½†æ˜¯å¯¹äºä¿®æ”¹å°é—­çš„â€çš„æ¦‚å¿µ |
| L | é‡Œæ°æ›¿æ¢åŸåˆ™ | é‡Œæ°æ›¿æ¢åŸåˆ™è®¤ä¸ºâ€œç¨‹åºä¸­çš„å¯¹è±¡åº”è¯¥æ˜¯å¯ä»¥åœ¨ä¸æ”¹å˜ç¨‹åºæ­£ç¡®æ€§çš„å‰æä¸‹è¢«å®ƒçš„å­ç±»æ‰€æ›¿æ¢çš„â€çš„æ¦‚å¿µã€‚å‚è€ƒ å¥‘çº¦å¼è®¾è®¡ã€‚ |
| I | æ¥å£éš”ç¦»åŸåˆ™ | æ¥å£éš”ç¦»åŸåˆ™è®¤ä¸ºâ€œå¤šä¸ªç‰¹å®šå®¢æˆ·ç«¯æ¥å£è¦å¥½äºä¸€ä¸ªå®½æ³›çš„æ¥å£â€[5]çš„æ¦‚å¿µã€‚ |
| D | ä¾èµ–åè½¬åŸåˆ™ | ä¾èµ–åè½¬åŸåˆ™è®¤ä¸ºä¸€ä¸ªæ–¹æ³•åº”è¯¥éµä»â€œä¾èµ–äºæŠ½è±¡è€Œä¸æ˜¯ä¸€ä¸ªå®ä¾‹â€[5]çš„æ¦‚å¿µã€‚ä¾èµ–æ³¨å…¥æ˜¯è¯¥åŸåˆ™çš„ä¸€ç§å®ç°æ–¹å¼ã€‚|
### 2.2.1 S å•ä¸€èŒè´£åŸåˆ™
- Single responsibility principle
- ä¸€ä¸ªç¨‹åºåªåšå¥½ä¸€ä»¶äº‹
- å¦‚æœåŠŸèƒ½ç‰¹åˆ«å¤æ‚å°±è¿›è¡Œæ‹†åˆ†
### 2.2.2 O å¼€å‘å°é—­åŸåˆ™
- Open Closed Principle
- å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
- å¢åŠ éœ€æ±‚æ—¶ï¼Œæ‰©å±•æ–°ä»£ç ï¼Œå¯¹éä¿®æ”¹å·²æœ‰ä»£ç 
- è¿™æ˜¯è½¯ä»¶è®¾è®¡çš„ç»ˆæç›®æ ‡
src/utils/request.js
```js
function parseJSON(response) {
    return response.json();
}
function checkStatus(response) {
    if(response.status >= 200 && response.status < 300) {
        return response;
    }
    const error = new Error(response.statusText);
    error.response = response;
    throw error;
}

export default function request(url, options) {
    return fetch(url, options)
        .then(checkStatus)
        .then(parseJSON)
        .then(data => {data})
        .catch(err => ({ err }));
}
```
### 2.2.3 L é‡Œæ°æ›¿æ¢åŸåˆ™
- Liskov Substitution Principle
- å­ç±»èƒ½è¦†ç›–çˆ¶ç±»
- çˆ¶ç±»èƒ½å‡ºç°çš„åœ°æ–¹å­ç±»å°±èƒ½å‡ºç°
- JSä½¿ç”¨æ¯”è¾ƒå°‘
### 2.2.4 I æ¥å£éš”ç¦»åŸåˆ™
- Interface Segregation Principle
- ä¿æŒæ¥å£çš„å•ä¸€ç‹¬ç«‹ï¼Œé¿å…å‡ºç°èƒ–æ¥å£
- JSä¸­æ²¡æœ‰æ¥å£ï¼Œä½¿ç”¨è¾ƒå°‘
- ç±»ä¼¼äºå•ä¸€èŒè´£åŸåˆ™ï¼Œæ›´å…³æ³¨æ¥å£
### 2.2.5 D ä¾èµ–å€’ç½®åŸåˆ™
- Dependence Inversion Principle
- é¢å‘æ¥å£ç¼–ç¨‹ï¼Œä¾èµ–äºæŠ½è±¡è€Œä¸ä¾èµ–äºå…·ä½“å®ç°
- ä½¿ç”¨æ–¹åªå…³æ³¨æ¥å£è€Œä¸å…³æ³¨å…·ä½“ç±»çš„å®ç°
- JSä¸­ä½¿ç”¨è¾ƒå°‘ï¼ˆæ²¡æœ‰æ¥å£ï¼Œå¼±ç±»å‹ï¼‰
# 3. 23ç§è®¾è®¡æ¨¡å¼
## 3.1 åˆ›å»ºå‹
- å·¥å‚æ¨¡å¼ï¼ˆå·¥å‚æ–¹æ³•æ¨¡å¼ã€æŠ½è±¡å·¥å‚æ¨¡å¼ã€ç®€å•å·¥å‚æ¨¡å¼ï¼‰
- å»ºé€ è€…æ¨¡å¼
- å•ä¾‹æ¨¡å¼
- åŸå‹æ¨¡å¼
## 3.2 ç»“æ„å‹æ¨¡å¼
- é€‚é…å™¨æ¨¡å¼
- è£…é¥°å™¨æ¨¡å¼
- ä»£ç†æ¨¡å¼
- å¤–è§‚æ¨¡å¼
- å·§æ¥æ¨¡å¼
- ç»„åˆæ¨¡å¼
- äº«å…ƒæ¨¡å¼
## 3.3 è¡Œä¸ºå‹
- ç­–ç•¥æ¨¡å¼
- æ¨¡æ¿æ–¹æ³•æ¨¡å¼
- è§‚å¯Ÿè€…æ¨¡å¼
- è¿­ä»£å™¨æ¨¡å¼
- èŒè´£é“¾æ¨¡å¼
- å‘½ä»¤æ¨¡å¼
- å¤‡å¿˜å½•æ¨¡å¼
- çŠ¶æ€æ¨¡å¼
- è®¿é—®è€…æ¨¡å¼
- ä¸­ä»‹è€…æ¨¡å¼
- è§£é‡Šå™¨æ¨¡å¼
# 4.å·¥å‚æ¨¡å¼
## 4.1 ç®€å•å·¥å‚æ¨¡å¼
- ç®€å•å·¥å‚æ¨¡å¼æ˜¯ç”±ä¸€ä¸ªå·¥å‚å¯¹è±¡å†³å®šåˆ›å»ºå‡ºå“ªä¸€ç§äº§å“ç±»çš„å®ä¾‹
### 4.1.1 ä»£ç 
```js
class Plant {
    constructor(name) {
        this.name = name;
    }
    grow() {
        console.log('growing~~~~~~');
    }
}
class Apple extends Plant {
    constructor(name) {
        super(name);
        this.taste = 'ç”œ';
    }
}
class Orange extends Plant {
    constructor(name) {
        super(name);
        this.taste = 'é…¸';
    }
}
class Factory {
    static create(name) {
        switch(name) {
            case 'apple':
                return new Apple('è‹¹æœ');
            case 'orange':
                return new Orange('æ©˜å­');
        }
    }
}
let apple = Factory.create('apple');
console.log(apple);
let orange = Factory.create('orange');
console.log(orange);
```
### 4.1.3
#### 4.1.3.1 jQuery
```js
class jQuery {
    constructor(selector) {
        let elements = Array.from(document.querySelectorAll(selector));
        let length = elements?elements.length: 0;
        for(let i=0; i<length; i++) {
            this[i] = elements[i];
        }
        this.length = length;
    }
    html() {

    }
}
window.$ = function(selector) {
    return new jQuery(selector);
}
```
### 4.1.3.2 React
```js
class Vnode {
    constructor(tag, attrs, children) {
        this.tag = tag;
        this.attrs = attrs;
        this.children = children;
    }
}
React.createElement = function(tag, attrs, children) {
    return new Vnode(tag, attr, children);
}
```
## 4.2 å·¥å‚æ–¹æ³•æ¨¡å¼
- å·¥å‚æ–¹æ³•æ¨¡å¼ Factory Method, åˆç§°å¤šæ€æ€§å·¥å‚æ¨¡å¼
- åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ä¸­ï¼Œæ ¸å¿ƒçš„å·¥å‚ç±»ä¸å†è´Ÿè´£æ‰€æœ‰çš„äº§å“çš„åˆ›å»ºï¼Œè€Œæ˜¯å°†å…·ä½“åˆ›å»ºçš„å·¥ä½œäº¤ç»™å­ç±»å»åšã€‚
### 4.2.1 ç±»å›¾
### 4.2.2 ä»£ç 
```js
class Plant {
    constructor(name) {
        this.name = name;
    }
    grow() {
        console.log('growing~~~~~~');
    }
}
class Apple extends Plant {
    constructor(name) {
        super(name);
        this.taste = 'ç”œ';
    }
}
class Orange extends Plant {
    constructor(name) {
        super(name);
        this.taste = 'é…¸';
    }
}
class AppleFactory {
    create() {
        return new Apple();
    }
}
class OrangeFactory {
    create() {
        return new Orange();
    }
}
const settings = {
    'apple': AppleFactory,
    'orange': OrangeFactory
}
let apple = new settings['apple']().create();
console.log(apple);
let orange = new settings['orange']().create();
console.log(orange);
```
## 4.3 æŠ½è±¡å·¥å‚æ¨¡å¼
- æŠ½è±¡å·¥å‚æ¨¡å¼æ˜¯æŒ‡å½“æœ‰å¤šä¸ªæŠ½è±¡è§’è‰²æ—¶ï¼Œä½¿ç”¨çš„ä¸€ç§å·¥å‚æ¨¡å¼
- æŠ½è±¡å·¥å‚æ¨¡å¼å¯ä»¥å‘å®¢æˆ·ç«¯æä¾›ä¸€ä¸ªæ¥å£ï¼Œä½¿å®¢æˆ·ç«¯åœ¨ä¸å¿…æŒ‡å®šäº§å“çš„å…·ä½“çš„æƒ…å†µä¸‹ï¼Œåˆ›å»ºå¤šä¸ªäº§å“æ—ä¸­çš„äº§å“å¯¹è±¡
### 4.3.1 ç±»å›¾
#### 4.3.2 ä»£ç 
```js
class Button {
    render() {

    }
}
class AppleButton {
    render() {
        console.log('è‹¹æœæŒ‰é’®');
    }
}
class WindowButton {
    render() {
        console.log('WindowsæŒ‰é’®');
    }
}
class Icon {
    render() {

    }
}
class AppleIcon {
    render() {
        console.log('è‹¹æœå›¾æ ‡');
    }
}
class WindowIcon {
    render() {
        console.log('Windowså›¾æ ‡');
    }
}
class Factory {
    createButton() {
    }
    createIcon() {
    }
}
class AppleFactory {
    createButton() {
        return new AppleButton();
    }
    createIcon() {
        return new AppleIcon();
    }
}
class WindowsFactory {
    createButton() {
        return new WindowButton();
    }
    createIcon() {
        return new WindowIcon();
    }
}
const settings = {
    'apple': AppleFactory,
    'windows': WindowsFactory
}
let appleFactory = new settings['apple']();
appleFactory.createButton().render();
appleFactory.createIcon().render();

let windowsFactory = new settings['windows']();
windowsFactory.createButton().render();
windowsFactory.createIcon().render();
```
# 5.å•ä¾‹æ¨¡å¼
## 5.1 ç±»å›¾
[singleobject](http://img.zhufengpeixun.cn/singleobject.jpg)
## 5.2 ä»£ç 
### 5.2.1 typescript
```js
class Window {
    constructor(name) {
        this.name = name;
    }
    static getInstance(name) {
        if(!this.instance) {
            this.instance = new Window(name);
        }
        return this.instance;
    }
}
var w1 = Window.getInstance();
var w2 = Window.getInstance();
console.log(w1 === w2);
```
### 5.2.2 ES5å•ä¾‹æ¨¡å¼
```js
let Window = function(name) {
    this.name = name;
}
Window.prototype.getName = function() {
    console.log(this.name);
}
Window.getInstance = (function(){
    let window = null;
    return function(name) {
        if(!window)
            window = new Window(name);
        return window;
    }
})();
let window = Window.getInstance('zfpx');
window.getName();
```
### 5.2.3 é€æ˜å•ä¾‹
```js
let Window = (function(){
    let window;
    let Window = function(name) {
        if(window) {
            return window;
        } else {
            this.name = name;
            return (window = this);
        }
    }
    Window.prototype.getName = function() {
        console.log(this.name);
    }
    return Window;
})();

let window1 = new Window('zfpx');
let window2 = new Window('zfpx');
window1.getName();
console.log(window1 === window2);
```
### 5.2.4 å•ä¾‹ä¸æ„å»ºåˆ†ç¦»
```js
function Window(name) {
    this.name = name;
}
Window.prototype.getName = function() {
    console.log(this.name);
}
let createSingle = (function() {
    let instance;
    return function(name) {
        if(!instance) {
            instance = new Window();
        }
        return instance;
    }
})();

let window1 = new createSingle('zfpx');
let window2 = new createSingle('zfpx');
window1.getName();
console.log(window1 === window2);
```
### 5.2.5 å°è£…å˜åŒ–
```js
function Window(name) {
    this.name = name;
}
Window.prototype.getName = function() {
    console.log(this.name);
}
let createSingle = function(Constructor) {
    let instance;
    return function() {
        if(!instance) {
            Constructor.apply(this, arguments);
            Object.setPrototypeOf(this, Constructor.prototype);
            instance = this;
        }
        return instance;
    }
};
let CreateWindow = createSingle(Window);
let window1 = new CreateWindow('zfpx');
let window2 = new CreateWindow('zfpx');
window1.getName();
console.log(window1 === window2);
```
### 5.2.6 å‘½åç©ºé—´
- ç”¨æˆ·ç¼–å†™çš„ä»£ç ä¸å†…éƒ¨çš„ç±»/å‡½æ•°/å¸¸é‡æˆ–ç¬¬ä¸‰æ–¹ç±»/å‡½æ•°/å¸¸é‡ä¹‹é—´çš„åå­—å†²çªã€‚
- ä¸ºå¾ˆé•¿çš„æ ‡è¯†ç¬¦åç§°åˆ›å»ºä¸€ä¸ªåˆ«å(æˆ–ç®€çŸ­)çš„åç§°ï¼Œæé«˜æºä»£ç çš„å¯è¯»æ€§ã€‚jQuery
```js
let $ = {
    ajax() {},
    get() {},
    post() {}
}
```
```js
let utils = {};
utils.def = function(namespace, fn) {
    let namespaces = namespace.split('.');
    let fnName = namespaces.pop();
    let current = utils;
    for(let i=0; i<namespaces.length; i++) {
        let namespace = namespaces[i];
        if(!current[namespace]) {
            current[namespace] = {};
        }
        current = current[namespace];
    }
    current[fnName] = fn;
}
utils.def('dom.attr', function(key) {
    console.log('dom.attr');
});
utils.def('dom.html', function(html) {
    console.log('dom.html');
});
utils.def('string.trim', function() {
    console.log('string.trim');
});
utils.dom.attr('src');
utils.string.trim(' aaa ');
```
## 5.3 åœºæ™¯
### 5.3.1 jQuery
```js
if(window.jQuery != null) {
    return window.jQuery;
} else {
    // init~~~~~~~
}
```
### 5.3.2 æ¨¡æ€çª—å£
```js
class Login {
    constructor() {
        this.element = document.createElement('div');
        this.element.innerHTML = (
            `
            ç”¨æˆ·å <input type="text"/>
            <button>ç™»å½•</button>
            `
        );
        this.element.style.cssText='width: 100px; height: 100px; position: absolute; left: 50%; top: 50%; display: block;';
        /* this.element.style.width='100px';
        this.element.style.height='100px';
        this.element.style.position='absolute';
        this.element.style.left='50%';
        this.element.style.top='50%'; */
        document.body.appendChild(this.element);
    }
    show() {
        this.element.style.display = 'block';
    }
    hide() {
        this.element.style.display = 'none';
    }
}
Login.getInstance = (function() {
    let instance;
    return function () {
        if(!instance) {
            instance = new Login();
        }
        return instance();
    }
})();

document.getElementById('showBtn').addEventListener('click', function(event) {
    Login.getInstance().show();
});
document.getElementById('hideBtn').addEventListener('click', function(event) {
    Login.getInstance().hide();
});
```
### 5.3.3 store
```js
function createStore(reducer) {
    let state;
    let listeners = [];
    function getState() {
        return state;
    }
    function dispatch(action) {
        state = reducer(state, action);
        listeners.forEach(l => l());
    }
    function subscribe(listener) {
        listeners.push(listener);
        return () => {
            listeners = listeners.filter(item => item != listener);
            console.log(listeners);
        }
    }
    dispatch({});
    return {
        getState,
        dispatch,
        subscribe
    }
}
let store = createStore();
```
### 5.3.4 ç¼“å­˜
```js
let express = require('express');
let fs = require('fs');
let cache = {};
let app = express();
app.get('/user/:id', function(req, res) {
    let id = req.params.id;
    let user = cache.get(id);
    if(user) {
        res.json(user);
    } else {
        fs.readFile(`./users/${id}.json`, 'utf8', function(err, data) {
            let user = JSON.parse(data);
            cache.put(id, user);
            res.json(user);
        });
    }
});

app.get('/user', function(req, res) {
    let user = req.query;
    fs.writeFile(`./users/${user.id}.json`, JSON.stringify(user), (err) => {
        console.log(err);
        res.json({code: 0, data: 'å†™å…¥æˆåŠŸ'});
    });
});
app.listen(3000);
```
### 5.3.5 LRUç¼“å­˜
- [lru-cache](https://leetcode.com/problems/lru-cache/)
- ä¸ºLRU Cacheè®¾è®¡ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå®ƒæ”¯æŒä¸¤ä¸ªæ“ä½œï¼š
    - 1) get(key): å¦‚æœkeyåœ¨cacheä¸­ï¼Œåˆ™è¿”å›å¯¹åº”çš„valueå€¼ï¼Œå¦åˆ™è¿”å›-1
    - 2) set(key, value): å¦‚æœkeyä¸åœ¨cacheä¸­ï¼Œåˆ™å°†è¯¥(key, value)æ’å…¥cacheä¸­ï¼ˆæ³¨æ„ï¼Œå¦‚æœcacheå·²æ»¡ï¼Œåˆ™å¿…é¡»æŠŠæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„å…ƒç´ ä»cacheä¸­åˆ é™¤ï¼‰; å¦‚æœkeyåœ¨cacheä¸­ï¼Œåˆ™é‡ç½®valueçš„å€¼ã€‚
    
```js
/*
- ç”¨ä¸€ä¸ªæ•°ç»„æ¥å­˜å‚¨æ•°æ®ï¼Œç»™æ¯ä¸€ä¸ªæ•°æ®é¡¹æ ‡è®°ä¸€ä¸ªè®¿é—®æ—¶é—´æˆ³
- æ¯æ¬¡æ’å…¥æ–°æ•°æ®é¡¹çš„æ—¶å€™ï¼Œå…ˆæŠŠæ•°ç»„ä¸­å­˜åœ¨çš„æ•°æ®é¡¹çš„æ—¶é—´æˆ³è‡ªå¢ï¼Œå¹¶å°†æ–°æ•°æ®é¡¹çš„æ—¶é—´æˆ³ç½®ä¸º0å¹¶æ’å…¥åˆ°æ•°ç»„ä¸­
- æ¯æ¬¡è®¿é—®æ•°ç»„ä¸­çš„æ•°æ®é¡¹çš„æ—¶å€™ï¼Œå°†è¢«è®¿é—®çš„æ•°æ®é¡¹çš„æ—¶é—´æˆ³ç½®ä¸º0.
- å½“æ•°ç»„ç©ºé—´å·²æ»¡æ—¶ï¼Œå°†æ—¶é—´æˆ³æœ€å¤§çš„æ•°æ®é¡¹æ·˜æ±°ã€‚
*/
class LRUCache {
    constructor(capacity) {
        this.capacity = capacity;
        this.members = [];
    }
    put(key, value) {
        let found = false;
        let oldestIndex = -1;
        let oldestAge = -1;
        for(let i=0; i<this.members.length; i++) {
            let member = this.members[i];
            if(member.age > oldestAge) {
                oldestIndex = i;
                oldestAge = member.age;
            }
            if(member.key == key) {
                this.members[i] = {key, value, age: 0};
                found = true;
            } else {
                member++;
            }
        }
        if(!found) {
            if(this.members.length >= this.capacity) {
                this.members.splice(oldestIndex, 1);
            }
            this.members[this.members.length] = {
                key,
                value,
                age: 0
            }
        }
    }
    get(key) {
        for(let i=0; i<this.members.length; i++) {
            let member = this.members[i];
            if(member.key == key) {
                member.age = 0;
                return member.value;
            }
        }
        return -1;
    }
}

let cache = new LRUCache(3);
cache.put('1', 1);
cache.put('2', 2);
cache.put('3', 3);
console.log(cache.get('1'));
console.log(cache.get('2'));
console.log(cache.get('3'));
cache.put('4', 4);
console.log(cache.get('1'));
console.log(cache.get('4'));
console.log(cache);
```
# 6.é€‚é…å™¨æ¨¡å¼
- æ—§çš„æ¥å£å’Œä½¿ç”¨è€…ä¸å…¼å®¹
- ä¸­é—´åŠ ä¸€ä¸ªé€‚é…å™¨è½¬æ¢æ¥å£
## 6.1 ç±»å›¾
## 6.2 ä»£ç 
```js
class Power {
    charge() {
        return '220V';
    }
}
class Adapter {
    constructor() {
        this.power = new Power();
    }
    charge() {
        let power = this.power.charge();
        return `${power} => 12V`;
    }
}
class Client {
    constructor() {
        this.adapter = new Adapter();
    }
    use() {
        console.log(this.adapter.charge());
    }
}
new Client().use();
```
## 6.3 åœºæ™¯
### 6.3.1 æ’ä»¶é€‚é…
- é€‚é…å‚æ•°
- é€‚é…åç«¯æ¥å£æ•°æ®
```js
function ajax(options) {
    let _default = {
        method: 'GET',
        dataType: 'json'
    }
    for(let attr in options) {
        _default[attr] = options[attr] || _default[attr];
    }
}
function get(url) {
    let options = { method: 'GET', url };
    ajax(options);
}
```
### 6.3.2 promisify
```js
let fs = require('fs');
function promisify(readFile) {
    return function(filename, encoding) {
        return new Promise(function(resolve, reject) {
            readFile(filename, encoding, function(err, data) {
                if(err) reject(err);
                else resolve(data);
            })
        });
    }
}
let readFile = promisify(fs.readFile);
readFile('./1.txt', 'utf8').then(data => console.log(data));
```
### 6.3.3 jquery
```js
let $ = require('jquery');
$.ajax({
    url,
    type: 'POST',
    dataType: 'json',
    data: {id: 1}
});

let $ = {
    ajax(options)  {
        fetch(options.url, {
            method: options.type,
            body: JSON.stringify(options.data)
        })
    }
}
```
### 6.3.4 computed
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://cdn.bootcss.com/vue/2.5.17/vue.js"></script>
    <title>vue</title>
</head>
<body>
<div id="root">
<p>{{name}}</p>
<p>{{upperName}}</p>
</div>   
    <script>
        let vm = new Vue({
            el: '#root',
            data: {
                name: 'zfpx'
            },
            computed: {
                upperName() {
                    return this.name.toUpperCase();
                }
            }
        });
    </script>
</body>
</html>
```
# 7.è£…é¥°å™¨æ¨¡å¼
- åœ¨ä¸æ”¹å˜å…¶åŸæœ‰çš„ç»“æ„å’ŒåŠŸèƒ½ä¸ºå¯¹è±¡æ·»åŠ æ–°åŠŸèƒ½
- è£…é¥°æ¯”ç»§æ‰¿æ›´åŠ çµæ´»
## 7.1 ç±»å›¾
## 7.2 ä»£ç 
```js
class Duck {
    eat(food) {
        console.llog('åƒ${food}');
    }
}
class TangDuck {
    constructor() {
        this.duck = new Duck();
    }
    eat() {
        this.duck.eat();
        console.log('è°¢è°¢');
    }
}
```
## 7.3 åŒ…è£…å™¨
è£…é¥°å™¨æ¨¡å¼æ˜¯å°†ä¸€ä¸ªå¯¹è±¡åµŒå…¥å¦ä¸€ä¸ªå¯¹è±¡ä¹‹ä¸­ï¼Œå®é™…ä¸Šç›¸å½“äºè¿™ä¸ªå¯¹è±¡è¢«å¦ä¸€ä¸ªå¯¹è±¡åŒ…è£…èµ·æ¥ï¼Œå½¢æˆä¸€æ¡åŒ…è£…é“¾ã€‚è¯·æ±‚éšç€è¿™æ¡é“¾æ¡ä¸€æ¬¡ä¼ é€’åˆ°æ‰€æœ‰çš„å¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡æœ‰å¤„ç†è¿™ä¸ªè¯·æ±‚çš„æœºä¼šã€‚
```js
class Coffee {
    make(water) {
        return `${water}+å’–å•¡`;
    }
    cost() {
        return 10;
    }
}
class MilkCoffee {
    constructor(parent) {
        this.parent = parent;
    }
    make(water) {
        return `${this.parent.make(water)}+ç‰›å¥¶`;
    }
    cost() {
        return this.parent.cost() + 1;
    }
}
class SugerCoffee {
    constructor(parent) {
        this.parent = parent;
    }
    make(water) {
        return `${this.parent.make(water)}+ç³–`;
    }
    cost() {
        return this.parent.cost()+2;
    }
}
let coffee = new Coffee();
let milkCoffee = new MilkCoffee(coffee);
let milksugerCoffee = new SugerCoffee(milkCoffee);
console.log(milksugerCoffee.make('æ°´')+'='+milksugerCoffee.cost());
```
## 7.4 AOP
- åœ¨è½¯ä»¶ä¸šï¼ŒAOPä¸ºAspect Oriented Programmingçš„ç¼©å†™ï¼Œæ„ä¸º:é¢å‘åˆ‡é¢ç¼–ç¨‹
- å¯ä»¥é€šè¿‡é¢„ç¼–è¯‘æ–¹å¼å’Œè¿è¡ŒæœŸåŠ¨æ€ä»£ç†å®ç°åœ¨ä¸ä¿®æ”¹æºä»£ç çš„æƒ…å†µä¸‹ç»™ç¨‹åºåŠ¨æ€ç»Ÿä¸€æ·»åŠ åŠŸèƒ½çš„ä¸€ç§æŠ€æœ¯
```js
Function.prototype.before = function(beforeFn) {
    let _this = this;
    return function() {
        beforeFn.apply(this, arguments);
        return _this.apply(this, arguments);
    }
}
Function.prototype.after = function(afterFn) {
    let _this = this;
    return function() {
        _this.apply(this, arguments);
        afterFn.apply(this, arguments);
    }
}
function buy(money, goods) {
    console.log(`èŠ±${money}ä¹°${goods}`);
}
buy = buy.before(function() {
    console.log(`å‘åª³å¦‡ç”³è¯·1å—é’±`);
});
buy = buy.after(function(){
    console.log(`æŠŠå‰©ä¸‹çš„2æ¯›é’±è¿˜ç»™åª³å¦‡`);
});
buy(.8, 'ç›');
```
## 7.5 åœºæ™¯
### 7.5.1 åŸ‹ç‚¹
åŸ‹ç‚¹åˆ†æï¼Œæ˜¯ç½‘ç«™åˆ†æçš„ä¸€ç§å¸¸ç”¨çš„æ•°æ®é‡‡é›†æ–¹æ³•
    - åŸ‹ç‚¹æ–¹å¼
        - æœåŠ¡å™¨å±‚é¢çš„ï¼šä¸»è¦æ˜¯é€šè¿‡å®¢æˆ·ç«¯çš„è¯·æ±‚è¿›è¡Œåˆ†æ
        - å®¢æˆ·ç«¯å±‚é¢çš„ï¼šé€šè¿‡åŸ‹ç‚¹è¿›è¡Œç›¸åº”çš„åˆ†æ
            - ä»£ç åŸ‹ç‚¹
            - è‡ªåŠ¨åŒ–åŸ‹ç‚¹: é€šè¿‡AOPæ€æƒ³å¯¹ç›¸åº”çš„æ–¹æ³•è¿›è¡Œç»Ÿè®¡
            - ç¬¬ä¸‰æ–¹å®ç°ç™¾åº¦ã€å‹ç›Ÿç­‰...
```html
<body>
    <button data-name="è¥¿ç“œ" id="watermelon">è¥¿ç“œ</button>
    <button data-name="è‹¹æœ" id="apple">è‹¹æœ</button>
    <script>
        let watermelon = document.getElementById('watermelon');
        let apple = document.getElementById('apple');
        Function.prototype.after = function(afterFn) {
            let _this = this;
            return function() {
                _this.apply(this, arguments);
                afterFn.apply(this, arguments);
            }
        }
        function click() {
            console.log('ç‚¹å‡»'+this.dataset.name);
        }
        click = click.after(function(){
            let img = new Image();
            img.src = `http://localhost:3000?name=${this.dataset.name}`;
        });
        Array.from(document.querySelectorAll('button')).forEach(function(button) {
            button.addEventListener('click', click);
        });
    </script>
</body>
```
```js
let express = require('express');
let app = express();
app.get('/', function(req, res){
    console.log('name', req.query.name);
    res.end('ok');
});
app.listen(3000);
```
### 7.3.2 è¡¨å•æ ¡éªŒ
```html
<body>
    <form action="">
        ç”¨æˆ·å<input type="text" name="username" id="username">
        å¯†ç <input type="text" name="password" id="password">
        <button id="submit-btn" >æäº¤</button>
    </form>
    <script>
        Function.prototype.before = function(beforeFn) {
            let _this = this;
            return function() {
                let ret = beforeFn.apply(this.arguments);
                if(ret) _this.apply(this, arguments);
            }
        }
        function submit() {
            alert('æäº¤è¡¨å•');
        }
        submit = submit.before(function() {
            let username = document.getElementById('username').value;
            if(username.length<6) {
                return alert('ç”¨æˆ·åä¸èƒ½å°‘äº6ä½');
            }
            return true;
        });
        submit = submit.before(function(){
            let username = document.getElementById('username').value;
            if(!username) {
                return alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
            }
            return true;
        });

        document.getElementById('submit-btn').addEventListener('click', submit);
    </script>
</body>
```
### 7.3.3 é˜²CSRFæ”»å‡»
- CSRFé€šè¿‡ä¼ªè£…æ¥è‡ªå—ä¿¡ä»»ç”¨æˆ·çš„è¯·æ±‚æ¥åˆ©ç”¨å—ä¿¡ä»»çš„ç½‘ç«™
### 7.3.3.1 å—ä¿¡ä»»ç½‘ç«™
```js
let express = require('express');
let bodyParser = require('body-parser');
let session = require('express-session');
let path = require('path')
let app = express();
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({extended: true}));
app.use(session({
    resave: "true",
    secret: 'zfpx',
    saveUninitialized: true
}));
app.set('view engine', 'ejs');
app.set('views', path.resolve('views'));
app.engine('html', require('ejs').__express);
let users = {};
app.get('/login', function(req, res) {
    res.render('login.html');
});
app.post('/login', function(req, res) {
    let body = req.body;
    users[body.username] = 100;
    req.session.username = body.username;
    res.json({code: 0, data: 'ç™»å½•æˆåŠŸ'});
});
app.get('/money', function(req, res) {
    res.send(users[req.session.username]+"å…ƒ");
});
app.get('/withdraw', function(req, res) {
    let token = req.session.token = Math.random() + '';
    res.cookie('token', token);
    res.render('withdraw.html');
});
app.post('/withdraw', function(req, res) {
    //users[req.session.username] -= (req.body.money?Number(req.body.money):10);
    //res.json({code:0,data:'å–æ¬¾æˆåŠŸ'});
    console.log(req.body.token, req.session.token)
    if(req.body.token== req.session.token){
    users[req.session.username] -= (req.body.money?parseInt(req.body.money):10);
    res.json({code:0,data:'å–æ¬¾æˆåŠŸ'});
    }else{
    res.json({code:1,data:'å–æ¬¾å¤±è´¥'});
    }
});
app.listen(3000);
```
#### 7.3.3.2 login
```html
<body>
    <a href="http://localhost:3000/money">æŸ¥çœ‹ä½™é¢</a>
    <a href="http://localhost:3000/withdraw">å–æ¬¾</a>
    ç”¨æˆ·å <input type="text" name="username" id="username">
    <button onclick="login()">æäº¤</button>
    <script>
        function ajax(method,url,data){
            let xhr = new XMLHttpRequest;
            xhr.open(method,url,true);
            xhr.setRequestHeader('Content-Type','application/json');
            xhr.onreadystatechange = function(){
                if(xhr.readyState == 4 && xhr.status == 200){
                    console.log(xhr.responseText);
                }
            }
            xhr.send(JSON.stringify(data));
        }
        function login(){
            let username = document.getElementById('username').value;
            ajax('POST','/login',{username});
        }
    </script>
</body>
```
#### 7.3.3.3 å–æ¬¾
```html
<body>
    é‡‘é¢ <input type="text" name="money" id="money">
    <button onclick="login()">æäº¤</button>
    <script>
        Function.prototype.before = function(beforeFn){
            let _this = this;
            return function(){
                beforeFn.apply(this,arguments);
                return _this.apply(this,arguments);
            }
        }

        function ajax(method,url,data){
            let xhr = new XMLHttpRequest;
            xhr.open(method,url,true);
            xhr.setRequestHeader('Content-Type','application/json');
            xhr.onreadystatechange = function(){
                if(xhr.readyState == 4 && xhr.status == 200){
                    console.log(xhr.responseText);
                }
            }
            xhr.send(JSON.stringify(data));
        }
        ajax = ajax.before(function(method,url,data){
            let result = document.cookie.match(/(^|; )token=(.+?)($|; )/);
            console.log(result,result);
            data.token = result[2];
        });
        function login(){
            let money = document.getElementById('money').value;
            ajax('POST','/withdraw',{money});
        }
    </script>
</body>
```
#### 7.3.3.4 éä¿¡ä»»ç½‘ç«™
```js
let express = require('express');
let path = require('path');
let app = express();
app.set('view engine', 'ejs');
app.set('views', path.resolve('views'));
app.engine('html', require('ejs').__express);

app.get('/', function(req, res){
    res.render('csrf.html');
});
app.get('/form', function(req, res){
    res.render('form.html');
});

app.listen(4000);
```
#### 7.3.3.5 csrf
```html
<body>
    <img src="https://www.baidu.com/img/bd_logo1.png"/>
    <iframe src="/form" frameborder="0" style="width:0;height:0"></iframe>
</body>
```
#### 7.3.3.6 form
```html
<body>
    <form id="myform" action="http://localhost:3000/withdraw" method="POST">
        <input type="text" name="money" id="money" value="10">
    </form>
    <script>
        setTimeout(function(){
            document.getElementById('myform').submit();
        },100);
    </script>
</body>
```
### 7.3.4 æ”¯æŒdecorators
- [babel-plugin-proposal-decorators](https://babeljs.io/docs/en/babel-plugin-proposal-decorators)
```json
"plugins": [
    ["@babel/plugin-proposal-decorators", {"legacy": true}],
    ["@babel/plugin-proposal-properties", { "loose": true }]
]
```
### 7.3.5 ç±»decorators
```js
@testable 
class Person {

}
function testable(target) {
    target.testable = true;
}
console.log(Person.testable);
```
```js
let Hooks = {
    componentWillMount() {
        console.log('componentWillMount');
    },
    componentDidMount() {
        console.log('componentDidMount');
    }
}
function mixins(...others) {
    return function(target) {
        Object.assign(target.prototype, ...others);
    }
}
@mixins(Hooks)
class Component {

}
let c = new Component();
console.log(c);
```
### 7.3.6 æ–¹æ³•decorators
- [core-decorators](https://www.npmjs.com/package/core-decorators)
```js
function readonly(target, attr, descriptor) {
    descriptor.writable = false;
}
class Circle {
    @readonly
    PI = 3.14;
}
let c = new Circle();
c.PI = 100;
console.log(c.PI);
```
```js
function logger(target, attr, descriptor) {
    let oldVal = descriptor.value;
    descriptor.value = function(...args) {
        console.log(`å‚æ•°ï¼š${args}`);
        return oldVal(...args);
    }
}
class Caculator {
    @logger
    sum(a, b) {
        return a + b;
    }
}
let c = new Caculator();
let ret = c.sum(1, 2);
console.log(ret);
```
```js
let {readonly}=require('core-decorators');
function deprecate(msg,options) {
    return function (target,attr,descriptor) {
        //DEPRECATION Caculator#sum: This function will be removed in future versions.
        let oldVal=descriptor.value;
        descriptor.value=function (...args) {
            let message=msg? msg:`DEPRECATION ${target.constructor.name}#${attr}: This function will be removed in future versions.`;
            let see=options&&options.url? `see ${options.url}`:``;
            console.warn(message+'\r\n'+see);
            return oldVal(...args);
        }
    }
}
class Caculator{
    @readonly PI=3.14;
    @deprecate
    sum(a,b) {
        return a+b;
    }
    @deprecate('stop using this')
    minus(a,b) {
        return a-b;
    }
    @deprecate('stop using this',{url:'http://www.baidu.com'})
    multiply(a,b) {
        return a*b;
    }
}
let c=new Caculator();
c.PI=5;
console.log(c.PI);
let ret=c.sum(1,2);
console.log(ret);
let ret2=c.minus(2,1);
console.log(ret2);
let ret3=c.multiply(2,1);
console.log(ret3);
```
# 8.ä»£ç†æ¨¡å¼
- ç”±äºä¸€ä¸ªå¯¹è±¡ä¸èƒ½ç›´æ¥å¼•ç”¨å¦å¤–ä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ä»£ç†å¯¹è±¡åœ¨è¿™ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸­ä»‹ä½œç”¨
- å¯ä»¥åœ¨ä½¿ç”¨è€…å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´åŠ ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œé€šè¿‡ä»£ç†å¯ä»¥å®ç°æ§åˆ¶
## 8.1 ç±»å›¾
## 8.2 ä»£ç 
```js
class Google {
    constructor() {}
    get() {
        return 'google';
    }
}
class Proxy {
    constructor() {
        this.google = new Google();
    }
    get() {
        return this.google.get();
    }
}
let proxy = new Proxy();
let ret = proxy.get();
console.log(ret);
```
## 8.3 åœºæ™¯
### 8.3.1 äº‹ä»¶å§”æ‰˜
- äº‹ä»¶æ•è·æŒ‡çš„æ˜¯ä»documentåˆ°è§¦å‘äº‹ä»¶çš„é‚£ä¸ªèŠ‚ç‚¹ï¼Œå³è‡ªä¸Šè€Œä¸‹çš„å»è§¦å‘äº‹ä»¶
- äº‹ä»¶å†’æ³¡æ˜¯è‡ªä¸‹è€Œä¸Šçš„å»è§¦å‘äº‹ä»¶
- ç»‘å®šäº‹ä»¶æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå°±æ˜¯æ§åˆ¶äº‹ä»¶è§¦å‘é¡ºåºæ˜¯å¦ä¸ºäº‹ä»¶æ•è·ã€‚trueä¸ºäº‹ä»¶æ•è·ï¼š false ä¸ºäº‹ä»¶å†’æ³¡ï¼Œé»˜è®¤falseã€‚

```html
<body>
    <ul id="list">
        <li>1</li>
        <li>2</li>
        <li>3</li>
    </ul>
<script>
  let list = document.querySelector('#list');
  list.addEventListener('click',event=>{
       alert(event.target.innerHTML);
  });     
</script>    
</body>
```
### 8.3.2 å›¾ç‰‡æ‡’åŠ è½½
#### 8.3.2.1 app.js
```js
let express = require('express');
let path = require('path');
let app = express();
app.get('/images/loading.gif', function(req, res) {
    res.sendFile(path.join(__dirname, req.path));
});
app.get('/images/:name', function(req, res) {
    setTimeout(() => {
        res.sendFile(path.join(__dirname, req.path));
    }, 2000);
});
app.get('/', function(req, res) {
    res.sendFile(path.resolve('index.html'));
});
app.listen(8080);
```
#### 8.3.2.2 index.html
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        *{
            padding:0;
            margin:0;
        }
        ul,li{
            list-style:none;
        }
        #background{
            position:absolute;
            border:1px solid green;
            right:10px;
            top:10px;
        }
        #background li{
            float:left;
            margin-left:10px;
            text-align:center;
            border:1px solid red;
            border-radius:5px;
        }
        #myImage{
            width:600px;
            height:400px;
            margin:100px auto;
        }
        #myImage img{
            width:100%;
            height:100%;
        }
    </style>
</head>
<body>
    <ul id="background">
        <li data-src="/images/bg1.jpg">å›¾ç‰‡1</li>
        <li data-src="/images/bg2.jpg">å›¾ç‰‡2</li>
    </ul>
    <div id="myImage">
    </div>
<script>
 let container = document.querySelector('#background');
 let myImage = document.querySelector('#myImage');
 let Background = (function(){
     let img = new Image();
     myImage.appendChild(img);
     return {
         set(src){
             img.src = src;
         }
     }
 })();
 let LoadingBackground = (function(){
     let img = new Image();
     img.onload = function(){
         Background.set(this.src);
     }
     return {
         set(src){ 
            Background.set(`/images/loading.gif`);
            img.src = src;
         }
     }
 })();
 container.addEventListener('click',function(event){
     let src = event.target.dataset.src;
     LoadingBackground.set(src+'?ts='+Date.now());
 });
</script>
</body>
</html>
```
- æ›´ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™å’Œå¼€é—­åŸåˆ™
### 8.3.3 é˜²æŠ–ä»£ç†
#### 8.3.3.1 todo.html
```html
<body>
    <ul id="todos">
    </ul>
    <script>
        let todos = document.querySelector('#todos');
        window.onload = function(){
            fetch('/todos').then(res=>res.json()).then(response=>{
                todos.innerHTML = response.map(item=>`<li "><input value="${item.id}" type="checkbox" ${item.completed?"checked":""}/>${item.text}</li>`).join('');
            });
        }
        function toggle(id){
        fetch(`/toggle/${id}`).then(res=>res.json()).then(response=>{
                console.log('response',response);
            });
        }
        todos.addEventListener('click',function(event){
            let checkbox = event.target;
            let id = checkbox.value;
            toggle(id);
        });
    </script>
</body>
```
#### 8.3.3.2 todos.html
```html
<body>
    <ul id="todos">
    </ul>
    <script>
        let todos = document.querySelector('#todos');
        window.onload = function(){
            fetch('/todos').then(res=>res.json()).then(response=>{
                todos.innerHTML = response.map(item=>`<li "><input value="${item.id}" type="checkbox" ${item.completed?"checked":""}/>${item.text}</li>`).join('');
            });
        }
        function toggle(id){
        fetch(`/toggle/${id}`).then(res=>res.json()).then(response=>{
                console.log('response',response);
            });
        }
        let LazyToggle = (function(id){
            let ids = [];
            let timer;
            return function(id){
                ids.push(id);
                if(!timer){
                timer = setTimeout(function(){
                    toggle(ids.join(','));
                    ids = null;
                    clearTimeout(timer);
                    timer = null;
                },2000);
                }
            }
        })();
        todos.addEventListener('click',function(event){
            let checkbox = event.target;
            let id = checkbox.value;
            LazyToggle(id);
        });
    </script>
```
#### 8.3.3.3 app.js
```js
let express=require('express');
let app=express();
app.use(express.static(__dirname));
let todos=[
    {id: 1,text: 'a',completed: false},
    {id: 2,text: 'b',completed: false},
    {id: 3,text: 'c',completed: false},
];
app.get('/todos',function (req,res) {
    res.json(todos);
});
app.get('/toggle/:id',function (req,res) {
    let id=req.params.id;
    todos = todos.map(item => {
        if (item.id==id) {
            item.completed=!item.completed;
        }
        return item;
    });
    res.json({code:0});
});
app.listen(8080);
```
#### 8.3.3.4 app.js
```js
app.get('/toggle/:ids', function(req, res){
    let ids = req.params.ids;
    ids = ids.split(',').map(item => parseInt(item));
    todos = todos.map(item => {
        if(ids.includes(items.id)) {
            item.completed = !item.completed;
        }
        return item;
    });
    res.json({code: 0});
});
```
### 8.3.4 ä»£ç†è·¨åŸŸ
#### 8.3.4.1 3000.js
```js
let express = require('express');
let app = express();
app.use(express.static(__dirname));
app.listen(3000);
```
#### 8.3.4.2 4000.js
```js
let express=require('express');
let app=express();
let bodyParser=require('body-parser');
app.use(bodyParser.urlencoded({extended:true}));
app.use(express.static(__dirname));
let users=[];
app.post('/register',function(req,res){
    let body=req.body;
    let target=body.target;
    let callback=body.callback;
    let username=body.username;
    let password=body.password;
    let user={username,password};
    let id=users.length==0? 1:users[users.length-1].id+1;
    user.id=id;
    users.push(user);
    res.status(302);
    res.header('Location',`${target}?callback=${callback}&args=${id}`);
    res.end();
});
app.listen(4000);
```
#### 8.3.4.3 index.html
```html
<script type="text/javascript">
  function receiveId(data){
      alert('ç”¨æˆ·ID='+data);
  }
</script>
<iframe name="proxyIframe" id="proxyIframe"  frameborder="0" ></iframe>
<form action="http://localhost:4000/register" method="POST" target="proxyIframe">
    <input type="hidden" name="callback" value="receiveId">
    <input type="hidden" name="target" value="http://localhost:3000/target.html">
    ç”¨æˆ·å<input type="text" name="username"/>
    å¯†ç <input type="text" name="password"/>
    <input type="submit" value="æäº¤">
</form>
```
#### 8.3.4.4 target.html
```js
window.onload = function() {
    var query = location.search.substr(1).split('&');
    let fn, args;
    for(let i=0, len = query.length; i<len;i++) {
        let item = query[i].split('=');
        if(item[0]=='callback') {
            fn = item[1];
        } else if(item[0] == 'args') {
            args = item[1];
        }
    }
    try {
        eval(`top.${fn}('${args}')`);
    } catch (e) {}
}
```
### 8.3.5 ä»£ç†ç¼“å­˜
ç¼“å­˜ä»£ç†å¯ä»¥ä¸ºå¼€é”€å¤§çš„è®¡ç®—ç»“æœæä¾›æš‚æ—¶çš„å­˜å‚¨
```js
0!=1, n!+(n-1)!xn
```
```js
let m = function(n) {
    if(n<=1) {
        return 1;
    } else {
        return n*m(n-1);
    }
}
function sum(n) {
    let result = 0;
    for(let i=1; i<=n; i++) {
        result += m(i);
    }
    return result;
}
console.log(sum(4));
```
```js
let m = function (n) {
    if (n<=1) {
        return 1;
    } else {
        return n*m(n-1);
    }
}
let sum=(function () {
    let cache={};
    return function sum(n) {
        let result=0;
        for (let i=1;i<=n;i++){
            let r=cache[i];
            if (r) {
                result+=r;
            } else {
                r=m(i);
                cache[i]=r;
                result+=r;
            }
        }
        return result;
    }
})()

console.log(sum(4));
```
### 8.3.5 $.proxy
- æ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–°å‡½æ•°ï¼Œå¹¶ä¸”è¿™ä¸ªæ–°å‡½æ•°å§‹ç»ˆä¿æŒäº†ç‰¹å®šçš„ä¸Šä¸‹æ–‡è¯­å¢ƒã€‚
- jQuery.proxy( function, context ) functionä¸ºæ‰§è¡Œçš„å‡½æ•°ï¼Œcontentä¸ºå‡½æ•°çš„ä¸Šä¸‹æ–‡thiså€¼ä¼šè¢«è®¾ç½®æˆè¿™ä¸ªobjectå¯¹è±¡
```html
<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script>
   let btn = document.getElementById('btn');
   btn.addEventListener('click',function(){
       setTimeout($.proxy((function(){
           $(this).css('color','red');
       }),this),1000);
   });    
</script>
```
### 8.3.6 Proxy
- Proxy ç”¨äºä¿®æ”¹æŸäº›æ“ä½œçš„é»˜è®¤è¡Œä¸º
- Proxy å¯ä»¥ç†è§£æˆï¼Œåœ¨ç›®æ ‡å¯¹è±¡ä¹‹å‰æ¶è®¾ä¸€å±‚â€œæ‹¦æˆªâ€ï¼Œå¤–ç•Œå¯¹è¯¥å¯¹è±¡çš„è®¿é—®ï¼Œéƒ½å¿…é¡»å…ˆé€šè¿‡è¿™å±‚æ‹¦æˆªï¼Œå› æ­¤æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥å¯¹å¤–ç•Œçš„è®¿é—®è¿›è¡Œè¿‡æ»¤å’Œæ”¹å†™ã€‚Proxy è¿™ä¸ªè¯çš„åŸæ„æ˜¯ä»£ç†ï¼Œç”¨åœ¨è¿™é‡Œè¡¨ç¤ºç”±å®ƒæ¥â€œä»£ç†â€æŸäº›æ“ä½œï¼Œå¯ä»¥è¯‘ä¸ºâ€œä»£ç†å™¨â€ã€‚
```js
let wang={
    name: 'wangy',
    age: 29,
    height:165
}
let wangMama=new Proxy(wang,{
    get(target,key) {
        if (key == 'age') {
            return wang.age-1;
        } else if (key == 'height') {
            return wang.height+5;
        }
        return target[key];
    },
    set(target,key,val) {
        if (key == 'boyfriend') {
            let boyfriend=val;
            if (boyfriend.age>40) {
                throw new Error('å¤ªè€');
            } else if (boyfriend.salary<20000) {
                throw new Error('å¤ªç©·');
            } else {
                target[key]=val;
                return true;
            }
        }
    }
});
console.log(wangMama.age);
console.log(wangMama.height);
wangMama.boyfriend={
    age: 41,
    salary:3000
}
```
- ä»£ç†æ¨¡å¼ VS é€‚é…å™¨æ¨¡å¼ é€‚é…å™¨æä¾›ä¸åŒæ¥å£ï¼Œä»£ç†æ¨¡å¼æä¾›ä¸€æ¨¡ä¸€æ ·çš„æ¥å£
- ä»£ç†æ¨¡å¼ VS è£…é¥°å™¨æ¨¡å¼ è£…é¥°å™¨æ¨¡å¼åŸæ¥çš„åŠŸèƒ½ä¸å˜è¿˜å¯ä»¥ä½¿ç”¨ï¼Œä»£ç†æ¨¡å¼æ”¹å˜åŸæ¥çš„åŠŸèƒ½